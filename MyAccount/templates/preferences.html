{% load static %}
<h1>My Account</h1>

<p>Your membership date: {{ date_of_creation }}</p>

<p>Your email: {{ user.email_addr }}</p>
<form method="POST" action="{% url 'update_email' %}">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Update Email</button>
</form>

<h2>Preferences</h2>
<form method="POST">
    {% csrf_token %}
    <label for="units">Preferred units:</label>
    <select name="units">
        <option value="metric" {% if user.preferred_units == 'metric' %}selected{% endif %}>Metric (kg, km, cm)</option>
        <!---Edit this for the required campus, such as weight and height-->
        <option value="imperial" {% if user.preferred_units == 'imperial' %}selected{% endif %}>Imperial (lbs, miles, feet)</option> 
    </select>
    <button type="submit">Save Preferences</button>
</form>

<h2>Delete Account</h2>
<button id="delete-btn" class="btn btn-danger">Delete Account</button>

<!-- Modal Popup for confirmation -->
<div id="confirm-popup" style="display:none;">
    <div style="background: rgba(0,0,0,0.5); width: 100%; height: 100%; position: fixed; top: 0; left: 0; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 5px; text-align: center;">
            <h3>Are you sure you want to delete your account?</h3>
            <p>Please type "yes" to confirm.</p>
            <input type="text" id="confirmation-input" placeholder="Type 'yes' to confirm" class="form-control" style="margin-bottom: 10px;">
            <div>
                <button id="confirm-btn" class="btn btn-danger" style="margin-right: 10px;">Confirm</button>
                <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Show confirmation popup when the delete button is clicked
    document.getElementById("delete-btn").addEventListener("click", function() {
        document.getElementById("confirm-popup").style.display = "flex";  // Display popup
    });

    // Hide the popup when cancel button is clicked
    document.getElementById("cancel-btn").addEventListener("click", function() {
        document.getElementById("confirm-popup").style.display = "none";  // Hide popup
    });

    // Handle confirmation when the confirm button is clicked
    document.getElementById("confirm-btn").addEventListener("click", function() {
        const confirmationInput = document.getElementById("confirmation-input").value;

        // Check if the user typed 'yes'
        if (confirmationInput.toLowerCase() === "yes") {
            // Send a POST request to delete the account
            fetch("{% url 'delete_account' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",  // Include CSRF token for security
                },
            })
            .then(response => {
                if (response.ok) {
                    // Redirect to confirmation or logout page
                    window.location.href = "{% url 'account_deleted' %}";  // Redirect after deletion
                } else {
                    alert("There was an error deleting your account.");
                }
            });
        } else {
            alert("You must type 'yes' to confirm deletion.");
        }
    });
</script>